# ひらがな認識アプリ実装ガイド

## 概要

既存の日本語文字認識モデル（etlcb_9b_model.tflite）を使用して、ひらがなのみを認識する Flutter アプリケーションの実装ガイドです。
demo_app の Flutter アプリに、このアセットを使ったキャンパスを使った手書き文字のひらがな認識アプリを作ってください。

## プロジェクト構成

### 必要なアセット

- `asssets/etlcb_9b_model.tflite` - 認識モデル（4.28MB）
- `asssets/etlcb_9b_labels.txt` - ラベルファイル（全文字リスト）

sample/kanji-recognition-android のコードを参考にしています。
モデルについては、こちらの README を参照してください。

### 依存パッケージ

- `tflite_flutter` - TensorFlow Lite モデルの実行
- `image` - 画像の前処理
- `flutter/services.dart` - アセットの読み込み

## 実装アーキテクチャ

### 1. 認識器クラスの設計

#### 責務

- モデルとラベルの読み込み
- ひらがなのフィルタリング
- 画像の前処理
- 推論の実行
- 結果の後処理

#### 状態管理

- モデルのインタープリター
- 全文字のラベルリスト
- ひらがなのインデックスマップ
- 認識可能なひらがなリスト

### 2. ひらがな抽出ロジック

#### ひらがなの定義

```
基本ひらがな: あ、い、う、え、お、か、き、く、け、こ...
濁音: が、ぎ、ぐ、げ、ご、ざ、じ、ず、ぜ、ぞ...
半濁音: ぱ、ぴ、ぷ、ぺ、ぽ
小文字: ぁ、ぃ、ぅ、ぇ、ぉ、ゃ、ゅ、ょ、っ
```

#### フィルタリング戦略

1. 基本的なひらがなのみを対象とする（小文字を除外）
2. または、Unicode の範囲で判定（0x3041〜0x3096）
3. 事前定義リストとの照合

### 3. 画像前処理

#### 必要な処理

1. **グレースケール変換** - カラー画像を白黒に
2. **リサイズ** - モデルの入力サイズに合わせる（通常 64x64）
3. **正規化** - ピクセル値を 0.0〜1.0 の範囲に
4. **形状の調整** - [1, 64, 64, 1]の 4 次元テンソルに

#### 注意点

- 補間方法は`cubic`推奨（文字の滑らかさを保つ）
- 背景は白、文字は黒として扱う
- 必要に応じて二値化処理を追加

### 4. 推論実行

#### 入力形式

- 形状: [1, height, width, channels]
- データ型: float32
- 値の範囲: 0.0〜1.0

#### 出力形式

- 形状: [1, num_classes]（num_classes は全文字数）
- データ型: float32
- 各要素は各文字の確率

### 5. 結果の後処理

#### フィルタリング手順

1. 全文字の確率値から、ひらがなのインデックスのみを抽出
2. ひらがなの中で最も高い確率の文字を選択
3. 上位 N 個の候補も保持（フィードバック用）

#### 閾値の設定

- 最低確信度: 0.1〜0.5 程度
- 確信度が低い場合は「認識できません」と返す

## UI/UX 設計

### 描画キャンバス

- タッチイベントの取得
- ストロークの描画
- クリア機能
- 画像への変換

### フィードバック

- リアルタイム認識 vs ボタン押下後認識
- 認識結果の表示（文字と確信度）
- 候補文字の表示
- 正誤判定（練習モード）

### 練習モード機能

- お手本の表示
- 正解判定
- 進捗管理
- 成績記録

## パフォーマンス最適化

### メモリ管理

- インタープリターの適切な初期化と破棄
- 画像データの効率的な処理
- 不要なコピーを避ける

### 推論速度

- 非同期処理の活用
- UI のブロッキングを避ける
- バッチ処理は不要（1 文字ずつ）

## エラーハンドリング

### 想定されるエラー

1. モデルファイルの読み込み失敗
2. ラベルファイルの読み込み失敗
3. 画像デコードエラー
4. 推論実行エラー
5. メモリ不足

### 対処方法

- 適切なエラーメッセージの表示
- フォールバック処理
- リトライ機能

## テスト戦略

### 単体テスト

- ひらがな抽出ロジック
- 画像前処理
- 結果のフィルタリング

### 統合テスト

- モデルの読み込みから推論まで
- 様々な手書きスタイルでの認識

### UI テスト

- 描画機能
- 結果表示
- エラー時の動作

## セキュリティとプライバシー

### 考慮事項

- 手書きデータはローカル処理のみ
- 外部サーバーへの送信なし
- 練習履歴の保存は任意

## 拡張可能性

### 将来の機能追加

1. カタカナ認識モード
2. 書き順チェック（ストローク情報の活用）
3. 学習曲線の可視化
4. カスタム練習セット
5. 手書きアニメーション再生

### モデルの更新

- より軽量なひらがな専用モデルへの移行
- 精度向上のための再学習
- オンデバイス学習の検討

## 配布時の注意

### アプリサイズ

- モデルファイル: 4.28MB
- 圧縮や量子化でさらに削減可能

### ライセンス

- ETL データベースの利用規約確認
- TensorFlow Lite のライセンス
- その他依存ライブラリのライセンス
